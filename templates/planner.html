{% extends "base.html" %}

{% block title %}Trip Planner - go.travel{% endblock %}
{% block description %}Create your perfect travel itinerary with AI. Enter your destination and preferences to get a personalized travel plan.{% endblock %}

{% block styles %}
/* Trip Planner Specific Styles */
.planner-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    padding: 2rem 0;
    text-align: center;
}

.planner-header h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.trip-form {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin: 2rem 0;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.interests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.interest-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.interest-item input[type="checkbox"] {
    width: auto;
}

.generate-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: transform 0.3s ease;
    width: 100%;
}

.generate-btn:hover {
    transform: translateY(-2px);
}

.generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Results Section */
.results-section {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin-top: 2rem;
    display: none;
}

.results-section.show {
    display: block;
}

.results-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
}

.results-header h2 {
    color: var(--text-color);
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
}

.trip-summary {
    color: var(--text-light);
    font-size: 1rem;
}

.itinerary-content {
    line-height: 1.8;
    color: var(--text-color);
}

.itinerary-content h3 {
    color: var(--primary-color);
    margin: 1.5rem 0 1rem 0;
    font-size: 1.25rem;
}

/* Highlight styles for enhanced content */
.highlight-gem {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    border: 1px solid #f59e0b;
    display: inline-block;
    margin: 0.125rem;
}

.travel-time {
    background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
    color: #0d47a1;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-weight: 600;
    border: 1px solid #2196f3;
    display: inline-block;
    margin: 0.125rem;
    font-size: 0.9rem;
}

/* Safety Panel */
.safety-panel {
    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
    border: 2px solid #ef4444;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.safety-header {
    text-align: center;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #ef4444;
    padding-bottom: 1rem;
}

.safety-header h3 {
    color: #dc2626;
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

.safety-header p {
    color: #7f1d1d;
    font-size: 0.9rem;
    margin: 0;
}

.safety-content {
    background: var(--white);
    padding: 1.5rem;
    border-radius: 8px;
    line-height: 1.6;
    border-left: 4px solid #ef4444;
}

.safety-content h4 {
    color: #dc2626;
    margin: 1rem 0 0.5rem 0;
    font-size: 1.1rem;
}

.safety-content ul {
    margin: 0.5rem 0 1rem 1.5rem;
}

.safety-content li {
    margin-bottom: 0.25rem;
    color: var(--text-color);
}

.safety-emergency {
    background: #fee2e2;
    border: 1px solid #fca5a5;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
}

.safety-emergency h5 {
    color: #dc2626;
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

/* Loading Animation */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Location Preview */
.location-preview {
    background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
    border: 2px solid var(--primary-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.location-map {
    background: var(--white);
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.location-map h5 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
    text-align: center;
}

/* Itinerary Management */
.itinerary-management {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid var(--accent-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.management-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.management-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
}

.management-card h4 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.management-card textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    resize: vertical;
}

.action-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    margin: 0.25rem;
}

.action-btn.primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    width: 100%;
}

.action-btn.secondary {
    background: var(--background-color);
    color: var(--text-color);
    border: 1px solid #e5e7eb;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .interests-grid {
        grid-template-columns: 1fr;
    }
    
    .management-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<!-- Planner Header -->
<section class="planner-header">
    <div class="container">
        <h1>Trip Planner</h1>
        <p>Create your perfect travel itinerary with AI assistance</p>
    </div>
</section>

<div class="container">
    <!-- Trip Planning Form -->
    <form id="tripForm" class="trip-form">
        <div class="form-group">
            <label for="destination">üåç Where do you want to go?</label>
            <div class="destination-input-container">
                <input type="text" id="destination" name="destination" placeholder="Enter your destination (e.g., Paris, France)" autocomplete="off" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="startDate">üìÖ Start Date</label>
                <input type="date" id="startDate" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">üìÖ End Date</label>
                <input type="date" id="endDate" name="endDate" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="people">ÔøΩ Number of People</label>
                <input type="number" id="people" name="people" min="1" max="20" value="1" required>
            </div>
            <div class="form-group">
                <label for="budget">üí∞ Budget Level</label>
                <select id="budget" name="budget" required>
                    <option value="">Select budget range</option>
                    <option value="budget">üíµ Budget-friendly</option>
                    <option value="moderate">üí∏ Moderate</option>
                    <option value="luxury">üíé Luxury</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>üé® Interests (select all that apply)</label>
            <div class="interests-grid">
                <div class="interest-item">
                    <input type="checkbox" id="museums" name="interests" value="museums">
                    <label for="museums">üèõÔ∏è Museums</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="food" name="interests" value="food">
                    <label for="food">üçΩÔ∏è Local Food</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="shopping" name="interests" value="shopping">
                    <label for="shopping">üõçÔ∏è Shopping</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nightlife" name="interests" value="nightlife">
                    <label for="nightlife">üåÉ Nightlife</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nature" name="interests" value="nature">
                    <label for="nature">üåø Nature</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="architecture" name="interests" value="architecture">
                    <label for="architecture">üèóÔ∏è Architecture</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="beaches" name="interests" value="beaches">
                    <label for="beaches">üèñÔ∏è Beaches</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="sports" name="interests" value="sports">
                    <label for="sports">‚öΩ Sports</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="specialRequests">üìù Special Requests (optional)</label>
            <textarea id="specialRequests" name="specialRequests" rows="3" placeholder="Any specific requirements, accessibility needs, or special interests..."></textarea>
        </div>

        <button type="submit" class="generate-btn" id="generateBtn">
            ‚ú® Generate My Perfect Itinerary
        </button>
    </form>

    <!-- Location Preview (shown when destination is entered) -->
    <div id="locationPreview" class="location-preview" style="display: none;">
        <div class="location-map">
            <h5>üìç Location Preview</h5>
            <div id="location-map" style="height: 300px; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="results-section">
        <div class="results-header">
            <h2 id="resultTitle">Your Personalized Itinerary</h2>
            <div class="trip-summary" id="tripSummary"></div>
        </div>
        <div id="itineraryContent" class="itinerary-content"></div>
        
        <!-- Safety Information Panel -->
        <div id="safetyPanel" class="safety-panel" style="display: none;">
            <div class="safety-header">
                <h3>üõ°Ô∏è Safety & Security Information</h3>
                <p>Important safety tips and emergency information for your trip</p>
            </div>
            <div id="safetyContent" class="safety-content"></div>
        </div>
        
        <!-- Itinerary Management Section -->
        <div id="itineraryManagement" class="itinerary-management" style="display: none;">
            <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">‚úèÔ∏è Manage Your Itinerary</h3>
            <div class="management-grid">
                <div class="management-card">
                    <h4>üîÑ Refine Your Itinerary</h4>
                    <textarea id="itinerary-changes" placeholder="Describe any changes you'd like to make to your itinerary..." rows="4"></textarea>
                    <button class="action-btn primary" onclick="refineItinerary()">Update Itinerary</button>
                </div>
                <div class="management-card">
                    <h4>üì§ Share & Export</h4>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="shareItinerary()">üîó Share</button>
                        <button class="action-btn secondary" onclick="downloadText()">üìÑ Download</button>
                        <button class="action-btn secondary" onclick="emailItinerary()">üìß Email</button>
                        <button class="action-btn secondary" onclick="downloadPDF()">üìã PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Configuration
const CONFIG = {
    BACKEND_URL: '',  // Use relative URLs for same-origin requests
    get GOOGLE_MAPS_API_KEY() {
        return window.APP_CONFIG?.google_maps_api_key || null;
    },
    get APP_NAME() {
        return window.APP_CONFIG?.app_name || 'go.travel';
    },
    get APP_DESCRIPTION() {
        return window.APP_CONFIG?.app_description || 'AI Travel Planner';
    },
    get APP_URL() {
        return window.APP_CONFIG?.app_url || 'https://gotravel.com';
    }
};

// Global variables
let map;
let autocomplete;
let currentItinerary = '';
let currentDestination = '';

// Initialize page when Google Maps API is ready
function initializePage() {
    console.log('üöÄ Initializing planner page...');
    
    initializeAutocomplete();
    setupDateCalculation();
    
    // Check if destination is pre-filled from URL params
    setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const destination = urlParams.get('destination');
        console.log('üîç Checking URL params for destination:', destination);
        
        if (destination) {
            const destinationInput = document.getElementById('destination');
            const decodedDestination = decodeURIComponent(destination);
            
            if (destinationInput) {
                destinationInput.value = decodedDestination;
                destinationInput.focus();
                
                // Load location info for the pre-filled destination
                loadLocationInfo(decodedDestination);
                
                // Show a notification that destination was pre-filled
                showMessage(`‚úàÔ∏è Destination pre-filled: ${decodedDestination}`, 'success');
                console.log('‚úÖ Destination pre-filled from URL:', decodedDestination);
            } else {
                console.error('‚ùå Destination input not found');
            }
        } else {
            console.log('‚ÑπÔ∏è No destination parameter in URL');
        }
        
        // Check for shared itinerary data
        checkForSharedItinerary();
    }, 100);
    
    console.log('‚úÖ Planner page initialization completed');
}

// Setup date validation
function setupDateCalculation() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.min = today;
    endDateInput.min = today;
    
    startDateInput.addEventListener('change', function() {
        // Update end date minimum to start date
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });
}

// Initialize autocomplete
function initializeAutocomplete() {
    const input = document.getElementById('destination');
    if (!input) {
        console.warn('‚ùå Destination input not found');
        return;
    }
    
    console.log('üîç Checking Google Maps API availability...');
    console.log('Google object:', typeof google);
    console.log('Google.maps:', typeof google?.maps);
    console.log('Google.maps.places:', typeof google?.maps?.places);
    
    if (typeof google !== 'undefined' && google.maps && google.maps.places && google.maps.places.Autocomplete) {
        try {
            autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['(cities)'],
                fields: ['place_id', 'geometry', 'name', 'formatted_address'],
                componentRestrictions: {} // Allow all countries
            });

            autocomplete.addListener('place_changed', function() {
                const place = autocomplete.getPlace();
                console.log('üìç Place selected from autocomplete:', place);
                
                if (place.geometry) {
                    const placeName = place.formatted_address || place.name;
                    loadLocationInfo(placeName);
                    showMessage('‚úÖ Location selected from suggestions', 'success');
                } else {
                    console.warn('‚ö†Ô∏è Place selected but no geometry available');
                }
            });
            
            // Add additional event listeners for better UX
            input.addEventListener('focus', function() {
                if (autocomplete) {
                    // Clear any previous value to show fresh suggestions
                    google.maps.event.trigger(autocomplete, 'focus');
                }
            });
            
            console.log('‚úÖ Google Places Autocomplete initialized successfully');
        } catch (error) {
            console.error('‚ùå Error initializing Google Places Autocomplete:', error);
            setupFallbackAutocomplete(input);
        }
    } else {
        console.warn('‚ùå Google Maps Places API not available - setting up fallback');
        console.log('Available Google API:', {
            google: typeof google,
            maps: typeof google?.maps,
            places: typeof google?.maps?.places,
            Autocomplete: typeof google?.maps?.places?.Autocomplete
        });
        setupFallbackAutocomplete(input);
    }
}

// Fallback autocomplete functionality
function setupFallbackAutocomplete(input) {
    if (!input) return;
    
    input.addEventListener('blur', function() {
        if (this.value.trim()) {
            loadLocationInfo(this.value.trim());
        }
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (this.value.trim()) {
                loadLocationInfo(this.value.trim());
            }
        }
    });
    
    console.log('‚úÖ Fallback autocomplete setup completed');
}

// Load location information
async function loadLocationInfo(location) {
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/location-info`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location: location })
        });

        if (response.ok) {
            const data = await response.json();
            displayLocationInfo(data);
        }
    } catch (error) {
        console.error('Error loading location info:', error);
    }
}

// Display location information
function displayLocationInfo(data) {
    if (!data || data.error) return;

    const preview = document.getElementById('locationPreview');
    
    // Show the preview (just the map)
    preview.style.display = 'block';
    
    // Create map if coordinates available
    if (data.location?.coordinates) {
        createInteractiveMap(
            data.location.coordinates.lat,
            data.location.coordinates.lng,
            data.location.address
        );
    }
}

// Create interactive map
function createInteractiveMap(lat, lng, title) {
    const mapContainer = document.getElementById('location-map');
    if (!mapContainer || !google || !google.maps) return;

    const mapOptions = {
        center: { lat: lat, lng: lng },
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(mapContainer, mapOptions);

    const marker = new google.maps.Marker({
        position: { lat: lat, lng: lng },
        map: map,
        title: title
    });

    const infoWindow = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;"><strong>${title}</strong></div>`
    });

    marker.addListener('click', function() {
        infoWindow.open(map, marker);
    });
}

// Form submission
document.getElementById('tripForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const destination = formData.get('destination');
    const startDate = formData.get('startDate');
    const endDate = formData.get('endDate');
    const people = formData.get('people');
    const budget = formData.get('budget');
    const specialRequests = formData.get('specialRequests');
    
    // Collect interests
    const interests = [];
    document.querySelectorAll('input[name="interests"]:checked').forEach(cb => {
        interests.push(cb.value);
    });
    
    if (!destination || !startDate || !endDate || !people || !budget) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }
    
    if (parseInt(people) < 1) {
        showMessage('Please enter a valid number of people (at least 1).', 'error');
        return;
    }
    
    // Calculate duration from dates
    const start = new Date(startDate);
    const end = new Date(endDate);
    const timeDifference = end.getTime() - start.getTime();
    const duration = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1;
    
    // Show loading
    const generateBtn = document.getElementById('generateBtn');
    const originalText = generateBtn.textContent;
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥ Generating...';
    
    const resultsSection = document.getElementById('results');
    const itineraryContent = document.getElementById('itineraryContent');
    
    resultsSection.classList.add('show');
    document.getElementById('resultTitle').textContent = `Your ${destination} Itinerary`;
    document.getElementById('tripSummary').textContent = `${duration} days ‚Ä¢ ${people} ${people == 1 ? 'person' : 'people'} ‚Ä¢ ${budget} budget ‚Ä¢ ${startDate} to ${endDate}`;
    
    itineraryContent.innerHTML = '<div class="loading"><div class="spinner"></div><span>Creating your perfect itinerary...</span></div>';
    
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/generate-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                destination,
                start_date: startDate,
                end_date: endDate,
                duration: parseInt(duration),
                people: parseInt(people),
                budget,
                interests,
                special_requests: specialRequests
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                currentDestination = destination;
                
                // Format itinerary with location information
                let fullItinerary = formatItinerary(data.itinerary);
                if (data.location_info) {
                    fullItinerary = addLocationInfoToItinerary(data.location_info) + fullItinerary;
                }
                itineraryContent.innerHTML = fullItinerary;
                
                // Show management section
                document.getElementById('itineraryManagement').style.display = 'block';
                
                // Show success message first
                showMessage('Itinerary generated successfully!', 'success');
                
                // Auto-scroll to results section after success notification is visible
                setTimeout(() => {
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                }, 800); // Reduced delay - scroll right after message appears
            } else {
                throw new Error(data.error || 'Failed to generate itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error:', error);
        itineraryContent.innerHTML = '';
        showMessage('Error generating itinerary. Please try again.', 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = originalText;
    }
});

// Add location information to itinerary
function addLocationInfoToItinerary(data) {
    if (!data || data.error) return '';
    
    let locationHTML = '<div style="background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border: 2px solid var(--primary-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">';
    locationHTML += '<h3 style="color: var(--primary-color); margin-bottom: 1rem;">üìç Destination Information</h3>';
    locationHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';
    
    if (data.location) {
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üìç Location</h5>
                <p style="color: var(--text-light);">${data.location.address}</p>
            </div>
        `;
    }
    
    if (data.weather) {
        const weather = data.weather;
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üå§Ô∏è Current Weather</h5>
                <p style="color: var(--text-light);">${Math.round(weather.main?.temp || 0)}¬∞C - ${weather.weather?.[0]?.description || 'N/A'}</p>
            </div>
        `;
    }
    
    if (data.timezone) {
        const timezone = data.timezone;
        const localTime = new Date().toLocaleString('en-US', {
            timeZone: timezone.timeZoneId,
            timeZoneName: 'short'
        });
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üïí Local Time</h5>
                <p style="color: var(--text-light);">${localTime}</p>
            </div>
        `;
    }
    
    locationHTML += '</div></div>';
    return locationHTML;
}

// Format itinerary
function formatItinerary(itinerary) {
    currentItinerary = itinerary;
    
    // Extract safety information
    const safetyInfo = extractSafetyInfo(itinerary);
    if (safetyInfo) {
        displaySafetyPanel(safetyInfo);
    }
    
    // Remove safety section from main itinerary display
    let itineraryWithoutSafety = itinerary.replace(/SAFETY\s*(&\s*SECURITY)?\s*SECTION?:?[\s\S]*$/i, '');
    
    // Remove unwanted characters and format
    let formatted = itineraryWithoutSafety
        .replace(/#{1,6}\s*/g, '') // Remove # characters
        .replace(/\*\*/g, '') // Remove ** characters
        .replace(/\*/g, '') // Remove * characters
        .replace(/Day (\d+):/g, '<h3>üìÖ Day $1</h3>')
        // Highlight hidden gems
        .replace(/(hidden gem|secret|local favorite|off.the.beaten.path|lesser.known)/gi, '<span class="highlight-gem">üíé $1</span>')
        // Highlight travel times
        .replace(/(\d+)\s*(minutes?|mins?|hours?|hrs?)\s*(walk|drive|by\s*\w+)/gi, '<span class="travel-time">üö∂ $1 $2 $3</span>')
        .replace(/(travel\s*time|journey|commute):\s*(\d+\s*\w+)/gi, '<span class="travel-time">üöó $1: $2</span>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    return `<div>${formatted}</div>`;
}

function extractSafetyInfo(itinerary) {
    // Look for safety section in the itinerary
    const safetyMatch = itinerary.match(/SAFETY\s*(&\s*SECURITY)?\s*SECTION?:?([\s\S]*)$/i);
    if (safetyMatch) {
        return safetyMatch[2].trim();
    }
    
    // Alternative patterns
    const altPatterns = [
        /SAFETY\s*INFORMATION:?([\s\S]*)$/i,
        /SAFETY\s*TIPS:?([\s\S]*)$/i,
        /EMERGENCY\s*INFORMATION:?([\s\S]*)$/i
    ];
    
    for (const pattern of altPatterns) {
        const match = itinerary.match(pattern);
        if (match) {
            return match[1].trim();
        }
    }
    
    return null;
}

function displaySafetyPanel(safetyInfo) {
    const safetyPanel = document.getElementById('safetyPanel');
    const safetyContent = document.getElementById('safetyContent');
    
    if (!safetyInfo) {
        safetyPanel.style.display = 'none';
        return;
    }
    
    // Format safety information
    let formattedSafety = safetyInfo
        .replace(/#{1,6}\s*/g, '') // Remove # characters
        .replace(/\*\*/g, '') // Remove ** characters
        .replace(/\*/g, '') // Remove * characters
        .replace(/Emergency\s*Contact\s*Numbers?:?/gi, '<div class="safety-emergency"><h5>üö® Emergency Contacts</h5>')
        .replace(/Common\s*Safety\s*Concerns?:?/gi, '</div><h4>‚ö†Ô∏è Safety Concerns</h4>')
        .replace(/Safe\s*Areas?\s*vs\s*Areas?\s*to\s*Avoid:?/gi, '<h4>üìç Areas Guide</h4>')
        .replace(/Local\s*Scams?:?/gi, '<h4>üé≠ Scam Awareness</h4>')
        .replace(/Safety\s*Apps?\s*or\s*Resources?:?/gi, '<h4>üì± Safety Resources</h4>')
        .replace(/Cultural\s*Customs?\s*and\s*Etiquette:?/gi, '<h4>ü§ù Cultural Guidelines</h4>')
        .replace(/Health\s*and\s*Medical:?/gi, '<h4>üè• Health & Medical</h4>')
        .replace(/Travel\s*Insurance:?/gi, '<h4>üõ°Ô∏è Insurance</h4>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    safetyContent.innerHTML = `<div>${formattedSafety}</div>`;
    safetyPanel.style.display = 'block';
    
    // Scroll to safety panel
    setTimeout(() => {
        safetyPanel.scrollIntoView({ behavior: 'auto', block: 'nearest' });
    }, 500);
}

// Itinerary management functions
async function refineItinerary() {
    const changes = document.getElementById('itinerary-changes').value.trim();
    if (!changes || !currentItinerary || !currentDestination) {
        showMessage('Please enter your requested changes.', 'error');
        return;
    }

    // Show loading state
    const updateBtn = document.querySelector('button[onclick="refineItinerary()"]');
    const originalText = updateBtn.textContent;
    updateBtn.disabled = true;
    updateBtn.textContent = 'üîÑ Updating...';
    
    // Show updating message
    showMessage('Updating your itinerary...', 'info');

    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/refine-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_itinerary: currentItinerary,
                feedback: changes,
                destination: currentDestination
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Update the display
                document.getElementById('itineraryContent').innerHTML = formatItinerary(data.itinerary);
                // Update the current itinerary variable for future operations
                currentItinerary = data.itinerary;
                document.getElementById('itinerary-changes').value = '';
                showMessage('Itinerary updated successfully!', 'success');
                
                // Auto-scroll to show the updated itinerary
                setTimeout(() => {
                    const resultsSection = document.getElementById('results');
                    if (resultsSection) {
                        resultsSection.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                    }
                }, 500);
            } else {
                throw new Error(data.error || 'Failed to refine itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error refining itinerary:', error);
        showMessage('Error updating itinerary. Please try again.', 'error');
    } finally {
        // Reset button state
        updateBtn.disabled = false;
        updateBtn.textContent = originalText;
    }
}

// Helper function to convert HTML itinerary to clean plain text
function getPlainTextItinerary() {
    if (!currentItinerary) {
        console.log('No currentItinerary available');
        return '';
    }
    
    // Create a temporary div to convert HTML to plain text
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = currentItinerary;
    
    // Convert HTML to clean plain text
    let plainText = tempDiv.textContent || tempDiv.innerText || '';
    
    // Enhanced cleaning for better readability
    plainText = plainText
        // Remove markdown-style characters
        .replace(/[*#_~`]+/g, '')
        // Remove excessive dashes and special characters
        .replace(/[-‚Äî‚Äì]+/g, '-')
        .replace(/[‚Ä¢¬∑]/g, '‚Ä¢')
        // Clean up excessive whitespace
        .replace(/\s+/g, ' ')
        .replace(/\n\s+/g, '\n')
        // Add proper spacing around day headers
        .replace(/(Day\s+\d+[:\s]*[^\n]*)/gi, '\n\nüìÖ $1\n')
        // Add spacing around time periods
        .replace(/(Morning|Afternoon|Evening|Night)[:\s]*([^\n]*)/gi, '\nüïê $1: $2\n')
        // Format bullet points consistently
        .replace(/[-‚Äî‚Äì]\s*/g, '\n‚Ä¢ ')
        .replace(/^\s*[‚Ä¢¬∑]\s*/gm, '‚Ä¢ ')
        // Clean up multiple newlines
        .replace(/\n{3,}/g, '\n\n')
        // Remove any remaining weird characters except common punctuation
        .replace(/[^\w\s\n‚Ä¢üìÖüïêüåçüìç‚ú®üåê.,!?():/-]/g, '')
        .trim();
    
    // Add header info if available
    const headerInfo = `üåç TRAVEL ITINERARY\n${currentDestination ? `üìç Destination: ${currentDestination}` : ''}\n${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n${'='.repeat(50)}\n\n`;
    
    const finalText = headerInfo + plainText + '\n\n' + '='.repeat(50) + `\n‚ú® Generated by ${CONFIG.APP_NAME} - ${CONFIG.APP_DESCRIPTION}\nüåê Create your own at ${CONFIG.APP_URL}`;
    
    console.log('Converted itinerary preview:', finalText.substring(0, 300) + '...');
    return finalText;
}

// Helper function to get extra clean text for PDF (removes markdown chars)
function getCleanPlainTextItinerary() {
    if (!currentItinerary) {
        console.log('No currentItinerary available');
        return '';
    }
    
    // Create a temporary div to convert HTML to plain text
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = currentItinerary;
    
    // Convert HTML to clean plain text
    let plainText = tempDiv.textContent || tempDiv.innerText || '';
    
    // Extra aggressive cleaning for PDFs and exports
    plainText = plainText
        // Remove ALL markdown-style characters aggressively
        .replace(/[*#_~`\[\]]+/g, '')
        // Remove special characters that cause formatting issues
        .replace(/[""'']/g, '"')
        .replace(/[‚Äì‚Äî]/g, '-')
        .replace(/[‚Ä¢¬∑‚ó¶‚ñ™‚ñ´]/g, '‚Ä¢ ')
        // Clean up excessive whitespace
        .replace(/\s+/g, ' ')
        .replace(/\n\s+/g, '\n')
        // Format day headers cleanly
        .replace(/(Day\s+\d+[:\s]*[^\n]*)/gi, '\n\nDay $1\n')
        // Format time periods cleanly
        .replace(/(Morning|Afternoon|Evening|Night)[:\s]*([^\n]*)/gi, '\n$1: $2\n')
        // Format bullet points consistently
        .replace(/[-‚Äî‚Äì]\s*/g, '\n‚Ä¢ ')
        .replace(/^\s*[‚Ä¢¬∑‚ó¶‚ñ™‚ñ´]\s*/gm, '‚Ä¢ ')
        // Clean up multiple newlines
        .replace(/\n{3,}/g, '\n\n')
        // Remove any remaining special characters except basic punctuation
        .replace(/[^\w\s\n.,!?():/-]/g, '')
        .trim();
    
    // Add clean header info
    const headerInfo = `TRAVEL ITINERARY\n${currentDestination ? `Destination: ${currentDestination}` : ''}\n${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}\n${'='.repeat(50)}\n\n`;
    
    const finalText = headerInfo + plainText + '\n\n' + '='.repeat(50) + `\nGenerated by ${CONFIG.APP_NAME} - ${CONFIG.APP_DESCRIPTION}\nCreate your own at ${CONFIG.APP_URL}`;
    
    return finalText;
}

function shareItinerary() {
    if (!currentItinerary) {
        showMessage('No itinerary to share. Please generate one first.', 'error');
        return;
    }
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to share itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    const safeDestination = currentDestination || 'Travel Destination';
    
    // Create a shareable URL with the itinerary data (for backup)
    const shareableUrl = generateShareableUrl();
    
    if (navigator.share) {
        // Use native sharing with full itinerary text
        navigator.share({
            title: `My ${safeDestination} Travel Itinerary`,
            text: `Check out my AI-generated travel itinerary for ${safeDestination}!\n\n${plainText}\n\nCreate your own at: ${shareableUrl}`,
        }).then(() => {
            showMessage('Itinerary shared successfully!', 'success');
        }).catch((error) => {
            console.log('Share failed, falling back to clipboard:', error);
            // Fallback to clipboard with full text
            const shareText = `Check out my AI-generated travel itinerary for ${safeDestination}!\n\n${plainText}\n\nCreate your own at: ${shareableUrl}`;
            navigator.clipboard.writeText(shareText).then(() => {
                showMessage('Full itinerary copied to clipboard!', 'success');
            }).catch(() => {
                showMessage('Unable to share or copy. Please copy manually.', 'error');
            });
        });
    } else {
        // Fallback: copy to clipboard with full text
        const shareText = `Check out my AI-generated travel itinerary for ${safeDestination}!\n\n${plainText}\n\nCreate your own at: ${shareableUrl}`;
        navigator.clipboard.writeText(shareText).then(() => {
            showMessage('Full itinerary copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Unable to copy to clipboard. Please copy manually.', 'error');
        });
    }
}

function generateShareableUrl() {
    if (!currentItinerary || !currentDestination) {
        return window.location.href;
    }
    
    try {
        // Create a compressed version of the itinerary data
        const itineraryData = {
            destination: currentDestination,
            duration: currentDuration || '3 days',
            interests: Array.from(document.querySelectorAll('input[name="interests"]:checked')).map(cb => cb.value),
            budget: document.getElementById('budget')?.value || 'moderate',
            timestamp: Date.now()
        };
        
        // Encode the data as base64 for URL sharing
        const encodedData = btoa(JSON.stringify(itineraryData));
        
        // Create the shareable URL
        const baseUrl = window.location.origin + window.location.pathname;
        const shareableUrl = `${baseUrl}?shared=${encodedData}`;
        
        return shareableUrl;
    } catch (error) {
        console.error('Error generating shareable URL:', error);
        return window.location.href;
    }
}
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(plainText).then(() => {
            showMessage('Itinerary copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Unable to copy to clipboard. Please copy manually.', 'error');
        });
    }
}

function downloadText() {
    if (!currentItinerary) {
        showMessage('No itinerary to download. Please generate one first.', 'error');
        return;
    }
    
    console.log('Starting download, currentItinerary:', currentItinerary ? 'exists' : 'missing');
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to export itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        const element = document.createElement('a');
        const file = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
        element.href = URL.createObjectURL(file);
        
        // Create a safe filename
        const safeDestination = currentDestination ? 
            currentDestination.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_') : 
            'itinerary';
        element.download = `${safeDestination}_itinerary.txt`;
        
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        
        // Clean up the object URL
        setTimeout(() => URL.revokeObjectURL(element.href), 100);
        
        showMessage('Itinerary downloaded successfully!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Error downloading itinerary. Please try again.', 'error');
    }
}

function downloadPDF() {
    if (!currentItinerary) {
        showMessage('No itinerary to export. Please generate one first.', 'error');
        return;
    }
    
    try {
        // Check if jsPDF is available - try multiple ways to access it
        let jsPDF;
        if (typeof window.jsPDF !== 'undefined') {
            jsPDF = window.jsPDF.jsPDF || window.jsPDF;
        } else if (typeof jsPDF !== 'undefined') {
            // Global jsPDF variable
        } else {
            console.log('jsPDF not available, falling back to text download');
            downloadText();
            return;
        }
        
        const doc = new jsPDF();
        
        // Get clean text content without markdown characters
        const plainText = getCleanPlainTextItinerary();
        
        // Set up PDF styling
        doc.setFont('helvetica');
        doc.setFontSize(16);
        
        // Add title
        const safeDestination = currentDestination || 'Travel Destination';
        doc.text(`${safeDestination} - Travel Itinerary`, 20, 20);
        
        // Add generated date
        doc.setFontSize(10);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
        
        // Add content
        doc.setFontSize(12);
        
        // Split text into lines that fit the page width
        const pageWidth = doc.internal.pageSize.getWidth();
        const margins = 20;
        const maxLineWidth = pageWidth - (margins * 2);
        
        // Clean the text and split into lines
        const cleanText = plainText
            .replace(/[üìÖüïêüåçüìç‚ú®üåê]/g, '') // Remove emojis for PDF
            .replace(/={50}/g, '--------------------') // Replace long equals with dashes
            .split('\n');
        
        let yPosition = 45;
        const lineHeight = 7;
        const pageHeight = doc.internal.pageSize.getHeight();
        
        cleanText.forEach(line => {
            if (line.trim() === '') {
                yPosition += lineHeight / 2;
                return;
            }
            
            // Check if we need a new page
            if (yPosition > pageHeight - 30) {
                doc.addPage();
                yPosition = 20;
            }
            
            // Split long lines
            const wrappedLines = doc.splitTextToSize(line, maxLineWidth);
            
            wrappedLines.forEach(wrappedLine => {
                if (yPosition > pageHeight - 30) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                // Make headers bold
                if (wrappedLine.includes('Day ') || wrappedLine.includes('TRAVEL ITINERARY')) {
                    doc.setFont('helvetica', 'bold');
                } else {
                    doc.setFont('helvetica', 'normal');
                }
                
                doc.text(wrappedLine, margins, yPosition);
                yPosition += lineHeight;
            });
        });
        
        // Save the PDF
        const safeFileName = safeDestination.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_');
        doc.save(`${safeFileName}_itinerary.pdf`);
        
        showMessage('PDF itinerary downloaded successfully!', 'success');
    } catch (error) {
        console.error('PDF generation error:', error);
        showMessage('Error generating PDF. Downloading as text instead.', 'warning');
        downloadText();
    }
}

function emailItinerary() {
    if (!currentItinerary) {
        showMessage('No itinerary to export. Please generate one first.', 'error');
        return;
    }
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to export itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        const safeDestination = currentDestination || 'Travel Destination';
        const subject = encodeURIComponent(`My ${safeDestination} Travel Itinerary`);
        const body = encodeURIComponent(`Here's my AI-generated travel itinerary for ${safeDestination}:\n\n${plainText}\n\nGenerated by ${CONFIG.APP_NAME} - ${CONFIG.APP_DESCRIPTION}`);
        
        // Create mailto link with size limit check
        const mailtoLink = `mailto:?subject=${subject}&body=${body}`;
        
        // Check if mailto URL is too long (some email clients have limits)
        if (mailtoLink.length > 2000) {
            // Fallback: copy to clipboard instead
            navigator.clipboard.writeText(plainText).then(() => {
                showMessage('Itinerary copied to clipboard! The email content was too long for direct email.', 'success');
            }).catch(() => {
                showMessage('Please copy the itinerary manually. Email content too long.', 'error');
            });
        } else {
            window.open(mailtoLink);
            showMessage('Email client opened with your itinerary!', 'success');
        }
    } catch (error) {
        console.error('Email error:', error);
        showMessage('Error preparing email. Please try copying to clipboard instead.', 'error');
    }
}

// Show message
function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = '#10b981';
            break;
        case 'error':
            backgroundColor = '#ef4444';
            break;
        case 'info':
            backgroundColor = '#3b82f6';
            break;
        default:
            backgroundColor = '#6b7280';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        max-width: 300px;
        background: ${backgroundColor};
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds (or 2 seconds for info messages)
    const timeout = type === 'info' ? 2000 : 3000;
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, timeout);
}

// Initialize page when Google Maps API is loaded
window.initializePage = initializePage;

// Also initialize on DOMContentLoaded as fallback
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM Content Loaded - checking initialization...');
    
    // Check URL parameters immediately
    const urlParams = new URLSearchParams(window.location.search);
    const destination = urlParams.get('destination');
    console.log('üîç URL destination parameter:', destination);
    
    if (destination) {
        const decodedDestination = decodeURIComponent(destination);
        console.log('üéØ Decoded destination:', decodedDestination);
        
        // Set destination immediately
        const destinationInput = document.getElementById('destination');
        if (destinationInput) {
            destinationInput.value = decodedDestination;
            console.log('‚úÖ Destination input set to:', decodedDestination);
            showMessage(`‚úàÔ∏è Destination pre-filled: ${decodedDestination}`, 'success');
        }
    }
    
    // Initialize other functionality
    setupDateCalculation();
    
    // Try to initialize the page after a delay if Google Maps hasn't done it
    setTimeout(function() {
        const destinationInput = document.getElementById('destination');
        if (destinationInput && destination && !destinationInput.value) {
            // Google Maps initialization might have failed, set manually
            destinationInput.value = decodeURIComponent(destination);
            console.log('üîÑ Fallback: Set destination via DOMContentLoaded');
        }
        
        // Try to initialize Google Places if available
        if (typeof initializeAutocomplete === 'function') {
            initializeAutocomplete();
        }
    }, 1000);
});

function checkForSharedItinerary() {
    const urlParams = new URLSearchParams(window.location.search);
    const sharedData = urlParams.get('shared');
    
    if (sharedData) {
        try {
            const itineraryData = JSON.parse(atob(sharedData));
            loadSharedItinerary(itineraryData);
        } catch (error) {
            console.error('Error loading shared itinerary:', error);
            showMessage('Invalid shared itinerary link.', 'error');
        }
    }
}

function loadSharedItinerary(data) {
    if (!data.destination) return;
    
    // Fill in the form with shared data
    document.getElementById('destination').value = data.destination;
    
    if (data.duration) {
        document.getElementById('duration').value = data.duration;
    }
    
    if (data.budget) {
        const budgetSelect = document.getElementById('budget');
        if (budgetSelect) {
            budgetSelect.value = data.budget;
        }
    }
    
    if (data.interests && Array.isArray(data.interests)) {
        data.interests.forEach(interest => {
            const checkbox = document.querySelector(`input[name="interests"][value="${interest}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    // Show a message that this is a shared itinerary
    showMessage(`Loading shared itinerary for ${data.destination}...`, 'info');
    
    // Auto-generate the itinerary
    setTimeout(() => {
        generateItinerary();
    }, 1000);
}
{% endblock %}