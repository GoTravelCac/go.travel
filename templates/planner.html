{% extends "base.html" %}

{% block title %}Trip Planner - go.travel{% endblock %}
{% block description %}Create your perfect travel itinerary with AI. Enter your destination and preferences to get a personalized travel plan.{% endblock %}

{% block styles %}
/* Trip Planner Specific Styles */
.planner-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    padding: 2rem 0;
    text-align: center;
}

.planner-header h1 {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.trip-form {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin: 2rem 0;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.interests-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.interest-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.interest-item input[type="checkbox"] {
    width: auto;
}

.generate-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    border: none;
    padding: 1rem 2rem;
    font-size: 1.1rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: transform 0.3s ease;
    width: 100%;
}

.generate-btn:hover {
    transform: translateY(-2px);
}

.generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Results Section */
.results-section {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
    margin-top: 2rem;
    display: none;
}

.results-section.show {
    display: block;
}

.results-header {
    border-bottom: 2px solid #e5e7eb;
    padding-bottom: 1rem;
    margin-bottom: 2rem;
}

.results-header h2 {
    color: var(--text-color);
    font-size: 1.75rem;
    margin-bottom: 0.5rem;
}

.trip-summary {
    color: var(--text-light);
    font-size: 1rem;
}

.itinerary-content {
    line-height: 1.8;
    color: var(--text-color);
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    transition: opacity 0.3s ease, filter 0.3s ease;
}

.itinerary-content h3 {
    color: var(--primary-color);
    margin: 2rem 0 1rem 0;
    font-size: 1.4rem;
    padding: 0.75rem 1rem;
    background: linear-gradient(135deg, var(--primary-color)10, transparent);
    border-left: 4px solid var(--primary-color);
    border-radius: 0 8px 8px 0;
    font-weight: 600;
}

.itinerary-content .time-block {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin: 0.75rem 0;
    border-left: 3px solid var(--secondary-color);
}

.itinerary-content .activity {
    margin: 1rem 0;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 6px;
    border-left: 2px solid #cbd5e1;
}

.itinerary-content .location {
    color: var(--secondary-color);
    font-weight: 500;
    font-size: 0.95rem;
}

.itinerary-content .cost {
    color: #059669;
    font-weight: 500;
    background: #ecfdf5;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    display: inline-block;
    margin: 0.25rem 0;
}

.itinerary-content .tip {
    background: #fef3c7;
    border: 1px solid #fbbf24;
    padding: 0.75rem;
    border-radius: 6px;
    margin: 0.5rem 0;
    font-style: italic;
    color: #92400e;
}

.formatted-itinerary {
    max-width: 100%;
    overflow-x: auto;
}

.itinerary-content p {
    margin: 0.75rem 0;
    line-height: 1.7;
}

.itinerary-content strong {
    color: var(--text-color);
    font-weight: 600;
}

.itinerary-content br + br {
    display: none;
}

/* Loading Animation */
.loading {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 2rem;
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid #e5e7eb;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Enhanced Loading States */
.loading-initial,
.loading-update {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 2rem;
    text-align: center;
    min-height: 300px;
}

.spinner-large {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1.5rem;
}

.loading-text h3 {
    color: var(--primary-color);
    margin: 0 0 0.5rem 0;
    font-size: 1.3rem;
    font-weight: 600;
}

.loading-text p {
    color: var(--text-muted);
    margin: 0 0 1.5rem 0;
    font-size: 1rem;
    line-height: 1.5;
}

.loading-steps {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
}

.step {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    background: #f1f5f9;
    color: var(--text-muted);
    font-size: 0.9rem;
    transition: all 0.3s ease;
    opacity: 0.5;
}

.step.active {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    opacity: 1;
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

/* Button Loading State */
button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    background: var(--text-muted) !important;
}

/* Location Preview */
.location-preview {
    background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%);
    border: 2px solid var(--primary-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.location-map {
    background: var(--white);
    padding: 1rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.location-map h5 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
    text-align: center;
}

/* Itinerary Management */
.itinerary-management {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid var(--accent-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin: 2rem 0;
}

.management-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.management-card {
    background: var(--white);
    padding: 1.5rem;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
}

.management-card h4 {
    font-size: 1.2rem;
    margin-bottom: 1rem;
    color: var(--primary-color);
}

.management-card textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
    resize: vertical;
}

.action-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    margin: 0.25rem;
}

.action-btn.primary {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    width: 100%;
}

.action-btn.secondary {
    background: var(--background-color);
    color: var(--text-color);
    border: 1px solid #e5e7eb;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .interests-grid {
        grid-template-columns: 1fr;
    }
    
    .management-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        grid-template-columns: 1fr;
    }
}
{% endblock %}

{% block content %}
<!-- Planner Header -->
<section class="planner-header">
    <div class="container">
        <h1>Trip Planner</h1>
        <p>Create your perfect travel itinerary with AI assistance</p>
    </div>
</section>

<div class="container">
    <!-- Trip Planning Form -->
    <form id="tripForm" class="trip-form">
        <div class="form-group">
            <label for="destination">üåç Where do you want to go?</label>
            <div class="destination-input-container">
                <input type="text" id="destination" name="destination" placeholder="Enter your destination (e.g., Paris, France)" autocomplete="off" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="startDate">üìÖ Start Date</label>
                <input type="date" id="startDate" name="startDate" required>
            </div>
            <div class="form-group">
                <label for="endDate">üìÖ End Date</label>
                <input type="date" id="endDate" name="endDate" required>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="people">ÔøΩ Number of People</label>
                <input type="number" id="people" name="people" min="1" max="20" value="1" required>
            </div>
            <div class="form-group">
                <label for="budget">üí∞ Budget Level</label>
                <select id="budget" name="budget" required>
                    <option value="">Select budget range</option>
                    <option value="budget">üíµ Budget-friendly</option>
                    <option value="moderate">üí∏ Moderate</option>
                    <option value="luxury">üíé Luxury</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>üé® Interests (select all that apply)</label>
            <div class="interests-grid">
                <div class="interest-item">
                    <input type="checkbox" id="museums" name="interests" value="museums">
                    <label for="museums">üèõÔ∏è Museums</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="food" name="interests" value="food">
                    <label for="food">üçΩÔ∏è Local Food</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="shopping" name="interests" value="shopping">
                    <label for="shopping">üõçÔ∏è Shopping</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nightlife" name="interests" value="nightlife">
                    <label for="nightlife">üåÉ Nightlife</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="nature" name="interests" value="nature">
                    <label for="nature">üåø Nature</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="architecture" name="interests" value="architecture">
                    <label for="architecture">üèóÔ∏è Architecture</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="beaches" name="interests" value="beaches">
                    <label for="beaches">üèñÔ∏è Beaches</label>
                </div>
                <div class="interest-item">
                    <input type="checkbox" id="sports" name="interests" value="sports">
                    <label for="sports">‚öΩ Sports</label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="specialRequests">üìù Special Requests (optional)</label>
            <textarea id="specialRequests" name="specialRequests" rows="3" placeholder="Any specific requirements, accessibility needs, or special interests..."></textarea>
        </div>

        <button type="submit" class="generate-btn" id="generateBtn">
            ‚ú® Generate My Perfect Itinerary
        </button>
    </form>

    <!-- Location Preview (shown when destination is entered) -->
    <div id="locationPreview" class="location-preview" style="display: none;">
        <div class="location-map">
            <h5>üìç Location Preview</h5>
            <div id="location-map" style="height: 300px; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="results" class="results-section">
        <div class="results-header">
            <h2 id="resultTitle">Your Personalized Itinerary</h2>
            <div class="trip-summary" id="tripSummary"></div>
        </div>
        <div id="itineraryContent" class="itinerary-content"></div>
        
        <!-- Itinerary Management Section -->
        <div id="itineraryManagement" class="itinerary-management" style="display: none;">
            <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">‚úèÔ∏è Manage Your Itinerary</h3>
            <div class="management-grid">
                <div class="management-card">
                    <h4>üîÑ Refine Your Itinerary</h4>
                    <textarea id="itinerary-changes" placeholder="Describe any changes you'd like to make to your itinerary..." rows="4"></textarea>
                    <button class="action-btn primary" onclick="refineItinerary()">Update Itinerary</button>
                </div>
                <div class="management-card">
                    <h4>üì§ Share & Export</h4>
                    <div class="action-buttons">
                        <button class="action-btn secondary" onclick="shareItinerary()">üîó Share</button>
                        <button class="action-btn secondary" onclick="downloadText()">üìÑ Download</button>
                        <button class="action-btn secondary" onclick="copyItinerary()">üìã Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Configuration
const CONFIG = {
    BACKEND_URL: '',  // Use relative URLs for same-origin requests
    GOOGLE_MAPS_API_KEY: '{{ google_api_key }}'
};

// Global variables
let map;
let autocomplete;
let currentItinerary = '';
let currentDestination = '';

// Initialize page when Google Maps API is ready
function initializePage() {
    initializeAutocomplete();
    setupDateCalculation();
    
    // Check if destination is pre-filled from URL params
    const urlParams = new URLSearchParams(window.location.search);
    const destination = urlParams.get('destination');
    if (destination) {
        document.getElementById('destination').value = destination;
        loadLocationInfo(destination);
    }
}

// Setup date validation
function setupDateCalculation() {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    // Set minimum date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.min = today;
    endDateInput.min = today;
    
    startDateInput.addEventListener('change', function() {
        // Update end date minimum to start date
        endDateInput.min = this.value;
        if (endDateInput.value && endDateInput.value < this.value) {
            endDateInput.value = this.value;
        }
    });
}

// Initialize autocomplete
function initializeAutocomplete() {
    const input = document.getElementById('destination');
    if (input && google && google.maps) {
        autocomplete = new google.maps.places.Autocomplete(input, {
            types: ['(cities)'],
            fields: ['place_id', 'geometry', 'name', 'formatted_address']
        });

        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (place.geometry) {
                loadLocationInfo(place.formatted_address || place.name);
            }
        });
    }
}

// Load location information
async function loadLocationInfo(location) {
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/location-info`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location: location })
        });

        if (response.ok) {
            const data = await response.json();
            displayLocationInfo(data);
        }
    } catch (error) {
        console.error('Error loading location info:', error);
    }
}

// Display location information
function displayLocationInfo(data) {
    if (!data || data.error) return;

    const preview = document.getElementById('locationPreview');
    
    // Show the preview (just the map)
    preview.style.display = 'block';
    
    // Create map if coordinates available
    if (data.location?.coordinates) {
        createInteractiveMap(
            data.location.coordinates.lat,
            data.location.coordinates.lng,
            data.location.address
        );
    }
}

// Create interactive map
function createInteractiveMap(lat, lng, title) {
    const mapContainer = document.getElementById('location-map');
    if (!mapContainer || !google || !google.maps) return;

    const mapOptions = {
        center: { lat: lat, lng: lng },
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };

    map = new google.maps.Map(mapContainer, mapOptions);

    const marker = new google.maps.Marker({
        position: { lat: lat, lng: lng },
        map: map,
        title: title
    });

    const infoWindow = new google.maps.InfoWindow({
        content: `<div style="padding: 5px;"><strong>${title}</strong></div>`
    });

    marker.addListener('click', function() {
        infoWindow.open(map, marker);
    });
}

// Form submission
document.getElementById('tripForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const destination = formData.get('destination');
    const startDate = formData.get('startDate');
    const endDate = formData.get('endDate');
    const people = formData.get('people');
    const budget = formData.get('budget');
    const specialRequests = formData.get('specialRequests');
    
    // Collect interests
    const interests = [];
    document.querySelectorAll('input[name="interests"]:checked').forEach(cb => {
        interests.push(cb.value);
    });
    
    if (!destination || !startDate || !endDate || !people || !budget) {
        showMessage('Please fill in all required fields.', 'error');
        return;
    }
    
    if (parseInt(people) < 1) {
        showMessage('Please enter a valid number of people (at least 1).', 'error');
        return;
    }
    
    // Calculate duration from dates
    const start = new Date(startDate);
    const end = new Date(endDate);
    const timeDifference = end.getTime() - start.getTime();
    const duration = Math.ceil(timeDifference / (1000 * 3600 * 24)) + 1;
    
    // Show loading
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '‚è≥ Generating...';
    
    const resultsSection = document.getElementById('results');
    const itineraryContent = document.getElementById('itineraryContent');
    
    resultsSection.classList.add('show');
    document.getElementById('resultTitle').textContent = `Your ${destination} Itinerary`;
    document.getElementById('tripSummary').textContent = `${duration} days ‚Ä¢ ${people} ${people == 1 ? 'person' : 'people'} ‚Ä¢ ${budget} budget ‚Ä¢ ${startDate} to ${endDate}`;
    
    itineraryContent.innerHTML = `
        <div class="loading-initial">
            <div class="spinner-large"></div>
            <div class="loading-text">
                <h3>‚ú® Creating Your Perfect Itinerary</h3>
                <p>Analyzing your preferences and crafting a personalized travel experience for ${destination}...</p>
                <div class="loading-steps">
                    <div class="step active">üåç Exploring destination</div>
                    <div class="step">üó∫Ô∏è Planning activities</div>
                    <div class="step">üçΩÔ∏è Finding restaurants</div>
                    <div class="step">üìù Finalizing details</div>
                </div>
            </div>
        </div>
    `;
    
    // Animate loading steps
    let currentStep = 0;
    const steps = document.querySelectorAll('.step');
    const stepInterval = setInterval(() => {
        if (currentStep < steps.length - 1) {
            steps[currentStep].classList.remove('active');
            currentStep++;
            steps[currentStep].classList.add('active');
        }
    }, 2000);
    
    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/generate-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                destination,
                start_date: startDate,
                end_date: endDate,
                duration: parseInt(duration),
                people: parseInt(people),
                budget,
                interests,
                special_requests: specialRequests
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                clearInterval(stepInterval);
                currentDestination = destination;
                
                // Fade out loading and show itinerary
                itineraryContent.style.opacity = '0';
                setTimeout(() => {
                    // Format itinerary with location information
                    let fullItinerary = formatItinerary(data.itinerary);
                    if (data.location_info) {
                        fullItinerary = addLocationInfoToItinerary(data.location_info) + fullItinerary;
                    }
                    itineraryContent.innerHTML = fullItinerary;
                    itineraryContent.style.opacity = '1';
                    
                    // Show management section
                    document.getElementById('itineraryManagement').style.display = 'block';
                    
                    // Show success message first
                    showMessage('Itinerary generated successfully! ‚ú®', 'success');
                    
                    // Auto-scroll to results section after success notification is visible
                    setTimeout(() => {
                        const resultsSection = document.getElementById('results');
                        if (resultsSection) {
                            resultsSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start',
                                inline: 'nearest'
                            });
                        }
                    }, 800);
                }, 300);
            } else {
                throw new Error(data.error || 'Failed to generate itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error:', error);
        clearInterval(stepInterval);
        itineraryContent.innerHTML = '';
        showMessage('Error generating itinerary. Please try again.', 'error');
    } finally {
        // Always restore button state
        generateBtn.disabled = false;
        generateBtn.innerHTML = 'üöÄ Generate My Itinerary';
    }
});

// Add location information to itinerary
function addLocationInfoToItinerary(data) {
    if (!data || data.error) return '';
    
    let locationHTML = '<div style="background: linear-gradient(135deg, #f0f9ff 0%, #ecfdf5 100%); border: 2px solid var(--primary-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">';
    locationHTML += '<h3 style="color: var(--primary-color); margin-bottom: 1rem;">üìç Destination Information</h3>';
    locationHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">';
    
    if (data.location) {
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üìç Location</h5>
                <p style="color: var(--text-light);">${data.location.address}</p>
            </div>
        `;
    }
    
    if (data.weather) {
        const weather = data.weather;
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üå§Ô∏è Current Weather</h5>
                <p style="color: var(--text-light);">${Math.round(weather.main?.temp || 0)}¬∞C - ${weather.weather?.[0]?.description || 'N/A'}</p>
            </div>
        `;
    }
    
    if (data.timezone) {
        const timezone = data.timezone;
        const localTime = new Date().toLocaleString('en-US', {
            timeZone: timezone.timeZoneId,
            timeZoneName: 'short'
        });
        locationHTML += `
            <div style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h5 style="color: var(--primary-color); margin-bottom: 0.5rem;">üïí Local Time</h5>
                <p style="color: var(--text-light);">${localTime}</p>
            </div>
        `;
    }
    
    locationHTML += '</div></div>';
    return locationHTML;
}

// Format itinerary
function formatItinerary(itinerary) {
    currentItinerary = itinerary;
    
    // Enhanced formatting with better structure
    let formatted = itinerary
        // Remove markdown characters
        .replace(/#{1,6}\s*/g, '') 
        .replace(/\*\*/g, '') 
        .replace(/\*/g, '') 
        
        // Format day headers
        .replace(/Day (\d+):/g, '<h3>üìÖ Day $1</h3>')
        
        // Format time periods (Morning, Afternoon, Evening)
        .replace(/(Morning|Afternoon|Evening|Lunch|Dinner|Breakfast)\s*\(([^)]+)\):/g, 
            '<div class="time-block"><strong>üïê $1 ($2)</strong>')
        .replace(/(Morning|Afternoon|Evening|Lunch|Dinner|Breakfast):/g, 
            '<div class="time-block"><strong>üïê $1</strong>')
        
        // Format activities with bullet points
        .replace(/^[\s]*-\s*([^:]+):\s*/gm, '<div class="activity"><strong>$1:</strong><br>')
        
        // Format addresses and locations
        .replace(/Address:\s*([^\n]+)/g, '<div class="location">üìç $1</div>')
        
        // Format costs
        .replace(/(?:Estimated cost|Cost)\s*(?:for \d+)?:\s*([^\n]+)/gi, '<div class="cost">üí∞ $1</div>')
        
        // Format tips
        .replace(/(?:Local Tip|Tip|Cultural Insight):\s*([^\n]+)/gi, '<div class="tip">üí° $1</div>')
        
        // Format transportation
        .replace(/Transportation:\s*([^\n]+)/gi, '<div class="location">ÔøΩ $1</div>')
        
        // Close time blocks and activities
        .replace(/(<div class="time-block">[^<]*<\/strong>)/g, '$1</div>')
        .replace(/(<div class="activity">[^<]*<br>)/g, '$1</div>')
        
        // Handle line breaks and paragraphs
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
    
    return `<div class="formatted-itinerary">${formatted}</div>`;
}

// Itinerary management functions
async function refineItinerary() {
    const changes = document.getElementById('itinerary-changes').value.trim();
    if (!changes || !currentItinerary || !currentDestination) {
        showMessage('Please enter your requested changes.', 'error');
        return;
    }

    // Get elements
    const updateBtn = document.querySelector('button[onclick="refineItinerary()"]');
    const itineraryContent = document.getElementById('itineraryContent');
    
    // Disable button and show loading state
    updateBtn.disabled = true;
    updateBtn.innerHTML = '‚è≥ Updating...';
    
    // Hide current itinerary with fade effect
    itineraryContent.style.opacity = '0.3';
    itineraryContent.style.filter = 'blur(2px)';
    itineraryContent.style.transition = 'opacity 0.3s ease, filter 0.3s ease';
    
    // Show updating message
    setTimeout(() => {
        itineraryContent.innerHTML = `
            <div class="loading-update">
                <div class="spinner-large"></div>
                <div class="loading-text">
                    <h3>üîÑ Updating Your Itinerary</h3>
                    <p>Incorporating your feedback and regenerating your perfect travel plan...</p>
                </div>
            </div>
        `;
        itineraryContent.style.opacity = '1';
        itineraryContent.style.filter = 'none';
    }, 300);

    try {
        const response = await fetch(`${CONFIG.BACKEND_URL}/api/refine-itinerary`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                current_itinerary: currentItinerary,
                feedback: changes,
                destination: currentDestination
            })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Fade out loading, then show updated itinerary
                itineraryContent.style.opacity = '0';
                
                setTimeout(() => {
                    // Update the display with new itinerary
                    itineraryContent.innerHTML = formatItinerary(data.itinerary);
                    itineraryContent.style.opacity = '1';
                    
                    // Update the current itinerary variable for future operations
                    currentItinerary = data.itinerary;
                    document.getElementById('itinerary-changes').value = '';
                    showMessage('Itinerary updated successfully! ‚ú®', 'success');
                    
                    // Auto-scroll to show the updated itinerary
                    setTimeout(() => {
                        const resultsSection = document.getElementById('results');
                        if (resultsSection) {
                            resultsSection.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'start' 
                            });
                        }
                    }, 500);
                }, 300);
            } else {
                throw new Error(data.error || 'Failed to refine itinerary');
            }
        } else {
            throw new Error('Server error');
        }
    } catch (error) {
        console.error('Error refining itinerary:', error);
        showMessage('Error updating itinerary. Please try again.', 'error');
        
        // Restore original itinerary on error
        itineraryContent.style.opacity = '0';
        setTimeout(() => {
            itineraryContent.innerHTML = formatItinerary(currentItinerary);
            itineraryContent.style.opacity = '1';
        }, 300);
    } finally {
        // Always restore button state
        updateBtn.disabled = false;
        updateBtn.innerHTML = 'Update Itinerary';
    }
}

// Helper function to convert HTML itinerary to clean plain text
function getPlainTextItinerary() {
    if (!currentItinerary) {
        console.log('No currentItinerary available');
        return '';
    }
    
    // Create a temporary div to convert HTML to plain text
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = currentItinerary;
    
    // Convert HTML to clean plain text
    let plainText = tempDiv.textContent || tempDiv.innerText || '';
    
    // Additional formatting for better readability
    plainText = plainText
        // Clean up excessive whitespace
        .replace(/\s+/g, ' ')
        .replace(/\n\s+/g, '\n')
        // Add proper spacing around day headers
        .replace(/(Day\s+\d+[:\s]*[^\n]*)/gi, '\n\nüìÖ $1\n')
        // Add spacing around time periods
        .replace(/(Morning|Afternoon|Evening|Night)[:\s]*([^\n]*)/gi, '\nÔøΩ $1: $2\n')
        // Format bullet points
        .replace(/‚Äî\s*/g, '\n‚Ä¢ ')
        // Clean up multiple newlines
        .replace(/\n{3,}/g, '\n\n')
        .trim();
    
    // Add header info if available
    const headerInfo = `üåç TRAVEL ITINERARY\n${currentDestination ? `üìç Destination: ${currentDestination}` : ''}\n${currentItinerary.includes('duration') ? '' : ''}\n${'='.repeat(50)}\n\n`;
    
    const finalText = headerInfo + plainText + '\n\n' + '='.repeat(50) + '\n‚ú® Generated by go.travel - AI Travel Planner\nüåê https://gotravel-ai-407949658262.us-central1.run.app';
    
    console.log('Converted itinerary preview:', finalText.substring(0, 300) + '...');
    return finalText;
}

function shareItinerary() {
    if (!currentItinerary) {
        showMessage('No itinerary to share. Please generate one first.', 'error');
        return;
    }
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to share itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    const safeDestination = currentDestination || 'Travel Destination';
    
    if (navigator.share) {
        navigator.share({
            title: `My ${safeDestination} Travel Itinerary`,
            text: plainText,
            url: window.location.href
        }).then(() => {
            showMessage('Itinerary shared successfully!', 'success');
        }).catch((error) => {
            console.log('Share failed, falling back to clipboard:', error);
            // Fallback to clipboard
            navigator.clipboard.writeText(plainText).then(() => {
                showMessage('Itinerary copied to clipboard!', 'success');
            }).catch(() => {
                showMessage('Unable to share or copy. Please copy manually.', 'error');
            });
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(plainText).then(() => {
            showMessage('Itinerary copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Unable to copy to clipboard. Please copy manually.', 'error');
        });
    }
}

function downloadText() {
    if (!currentItinerary) {
        showMessage('No itinerary to download. Please generate one first.', 'error');
        return;
    }
    
    console.log('Starting download, currentItinerary:', currentItinerary ? 'exists' : 'missing');
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to export itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        const element = document.createElement('a');
        const file = new Blob([plainText], { type: 'text/plain;charset=utf-8' });
        element.href = URL.createObjectURL(file);
        
        // Create a safe filename
        const safeDestination = currentDestination ? 
            currentDestination.replace(/[^a-z0-9\s]/gi, '').replace(/\s+/g, '_') : 
            'itinerary';
        element.download = `${safeDestination}_itinerary.txt`;
        
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
        
        // Clean up the object URL
        setTimeout(() => URL.revokeObjectURL(element.href), 100);
        
        showMessage('Itinerary downloaded successfully!', 'success');
    } catch (error) {
        console.error('Download error:', error);
        showMessage('Error downloading itinerary. Please try again.', 'error');
    }
}

function copyItinerary() {
    if (!currentItinerary) {
        showMessage('No itinerary to copy. Please generate one first.', 'error');
        return;
    }
    
    const plainText = getPlainTextItinerary();
    
    if (!plainText || plainText.trim() === '') {
        showMessage('Unable to copy itinerary. Please try generating a new one.', 'error');
        return;
    }
    
    try {
        navigator.clipboard.writeText(plainText).then(() => {
            showMessage('Itinerary copied to clipboard!', 'success');
        }).catch(() => {
            showMessage('Unable to copy to clipboard. Please copy manually.', 'error');
        });
    } catch (error) {
        console.error('Copy error:', error);
        showMessage('Error copying itinerary. Please try again.', 'error');
    }
}

// Show message
function showMessage(message, type) {
    // Create message element
    const messageDiv = document.createElement('div');
    messageDiv.className = `${type}-message`;
    
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = '#10b981';
            break;
        case 'error':
            backgroundColor = '#ef4444';
            break;
        case 'info':
            backgroundColor = '#3b82f6';
            break;
        default:
            backgroundColor = '#6b7280';
    }
    
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        max-width: 300px;
        background: ${backgroundColor};
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    `;
    messageDiv.textContent = message;
    
    document.body.appendChild(messageDiv);
    
    // Remove after 3 seconds (or 2 seconds for info messages)
    const timeout = type === 'info' ? 2000 : 3000;
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, timeout);
}

// Initialize page when Google Maps API is loaded
window.initializePage = initializePage;

// Fallback initialization for duration calculation if Google Maps fails
document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to allow Google Maps to load first
    setTimeout(function() {
        // If Google Maps hasn't initialized the date calculation, do it manually
        const durationInput = document.getElementById('duration');
        if (durationInput && durationInput.value === '0') {
            setupDateCalculation();
        }
    }, 1000);
});
{% endblock %}